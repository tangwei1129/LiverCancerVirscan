#!/bin/bash
find fastq/*.fastq.gz | perl -ne 'chomp; $in=$_; $out=$in; $out=~s/fastq\///; $out=~ s/\_S(\d+)_R1_001.fastq.gz//g; $bowtie_cmd = "module load bowtie/1.2.3 && bowtie -n 3 -l 30 -e 1000 --tryhard --nomaqround --norc --best --sam --quiet reference/ref_vir2 -q $in > $out\.sam 2>run_bowtie\_$out\.err "; $bam_cmd="module load samtools && samtools view -bS $out\.sam >$out\.bam 2>run_samtool_view.err && samtools sort $out\.bam -o $out\.sorted.bam >run\_$out\.sorted.log 2>run_samtools_sort.err && samtools index $out\.sorted.bam 2>run_samtools_index.err "; $bam_stats = "module load bamtools && bamtools stats -in $out\.sorted.bam 1>run_bam_stats\_$out.log 2>run_bam_stats\_$out.err "; print "$bowtie_cmd && $bam_cmd && $bam_stats && rm $out\.sam\n"' > bowtie.swarm
swarm -t 8 -g 32 --time 08:00:00 -f bowtie.swarm
